name: Deploy to Production

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      skip_checks:
        description: 'Skip lint and build checks'
        required: false
        default: false
        type: boolean

concurrency:
  group: production-deploy
  cancel-in-progress: false

env:
  NODE_VERSION: '22'

jobs:
  # ── Job 1: Verify ────────────────────────────────────────────
  verify:
    name: Verify
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_checks }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

  # ── Job 2: Deploy ────────────────────────────────────────────
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: [verify]
    if: ${{ always() && (needs.verify.result == 'success' || needs.verify.result == 'skipped') }}
    steps:
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DO_API_TOKEN }}

      - name: Create deployment
        id: deploy
        run: |
          DEPLOYMENT=$(doctl apps create-deployment ${{ secrets.DO_APP_ID }} --format ID --no-header)
          echo "deployment_id=$DEPLOYMENT" >> "$GITHUB_OUTPUT"
          echo "Deployment created: $DEPLOYMENT"

      - name: Wait for deployment
        run: |
          APP_ID="${{ secrets.DO_APP_ID }}"
          DEPLOY_ID="${{ steps.deploy.outputs.deployment_id }}"
          MAX_WAIT=600
          ELAPSED=0

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            STATUS=$(doctl apps get-deployment "$APP_ID" "$DEPLOY_ID" --format Phase --no-header 2>/dev/null || echo "UNKNOWN")
            echo "[$ELAPSED s] Deployment status: $STATUS"

            case "$STATUS" in
              ACTIVE)
                echo "Deployment successful!"
                exit 0
                ;;
              ERROR|FAILED|CANCELED)
                echo "Deployment failed with status: $STATUS"
                exit 1
                ;;
            esac

            sleep 10
            ELAPSED=$((ELAPSED + 10))
          done

          echo "Deployment timed out after ${MAX_WAIT}s"
          exit 1

  # ── Job 3: Post-deploy ───────────────────────────────────────
  post-deploy:
    name: Post-deploy
    runs-on: ubuntu-latest
    needs: [deploy]
    if: ${{ needs.deploy.result == 'success' }}
    steps:
      - name: Purge Cloudflare cache
        run: |
          curl -s -X POST \
            "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/purge_cache" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"purge_everything":true}' | jq .

      - name: Create GitHub deployment status
        uses: actions/github-script@v7
        with:
          script: |
            const ref = context.ref || context.sha;
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: ref,
              environment: 'production',
              auto_merge: false,
              required_contexts: [],
              description: `Deploy ${ref}`,
            });
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment.data.id,
              state: 'success',
              environment_url: 'https://mussi.tech',
              description: 'Deployed successfully',
            });

      - name: Summary
        run: |
          TAG="${GITHUB_REF_NAME:-manual}"
          echo "## Deployment Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Detail | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Version** | \`$TAG\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **URL** | https://mussi.tech |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Status** | Deployed |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Cache** | Purged |" >> "$GITHUB_STEP_SUMMARY"
